import{a as R,u as _,j as e}from"./index-D-t1j5i9.js";import{r as t,F as A}from"./monaco-DbcDPHM6.js";import{g as M,a as F}from"./config-BEHjlgW2.js";import"./react-DouVtcfL.js";const T=(l,m,u=!0)=>{const n=t.useRef(null),d=t.useRef(null),h=t.useRef(m),i=t.useRef(0),[b,g]=t.useState(!1),[x,p]=t.useState(null);t.useEffect(()=>{h.current=m},[m]);const v=t.useCallback(()=>{var f;if(!(!u||((f=n.current)==null?void 0:f.readyState)===WebSocket.OPEN)){n.current&&(n.current.close(),n.current=null);try{console.log("üîå Connecting to WebSocket:",l);const c=new WebSocket(l);c.onopen=()=>{console.log("‚úÖ WebSocket connected"),g(!0),p(null),i.current=0},c.onmessage=o=>{try{const r=JSON.parse(o.data);h.current(r)}catch(r){console.error("Error parsing WebSocket message:",r)}},c.onerror=o=>{console.error("WebSocket error:",o),p("Connection error")},c.onclose=o=>{if(console.log("‚ùå WebSocket disconnected",o.code,o.reason),g(!1),n.current=null,u&&i.current<10){i.current+=1;const r=Math.min(1e3*i.current,5e3);console.log(`üîÑ Reconnecting in ${r}ms (attempt ${i.current})...`),d.current=window.setTimeout(()=>{v()},r)}else i.current>=10&&(console.error("‚ùå Max reconnect attempts reached"),p("Failed to maintain connection"))},n.current=c}catch(c){console.error("Error creating WebSocket:",c),p("Failed to connect")}}},[l,u]);return t.useEffect(()=>(u&&v(),()=>{d.current&&(clearTimeout(d.current),d.current=null),n.current&&(n.current.close(),n.current=null),g(!1)}),[u,v]),{sendMessage:t.useCallback(f=>{var c;((c=n.current)==null?void 0:c.readyState)===WebSocket.OPEN?n.current.send(JSON.stringify(f)):console.warn("WebSocket is not connected. Cannot send message.")},[]),isConnected:b,error:x}},B=M(),$=F(),z=[{value:"python",label:"Python"},{value:"javascript",label:"JavaScript"},{value:"typescript",label:"TypeScript"},{value:"java",label:"Java"},{value:"cpp",label:"C++"},{value:"csharp",label:"C#"},{value:"go",label:"Go"},{value:"rust",label:"Rust"},{value:"php",label:"PHP"},{value:"ruby",label:"Ruby"},{value:"swift",label:"Swift"},{value:"kotlin",label:"Kotlin"},{value:"sql",label:"SQL"},{value:"html",label:"HTML"},{value:"css",label:"CSS"},{value:"json",label:"JSON"},{value:"markdown",label:"Markdown"}];function O(){const{spaceId:l}=R(),m=_(),[u,n]=t.useState("// Loading..."),[d,h]=t.useState("python"),[i,b]=t.useState(1),[g,x]=t.useState(""),[p,v]=t.useState(!0),[S,f]=t.useState(null),[c,o]=t.useState(!1),[r,k]=t.useState(!1);t.useEffect(()=>{(async()=>{try{const a=await fetch(`${B}/api/spaces/${l}`);if(!a.ok)throw new Error("Space not found");const N=await a.json();n(N.code),h(N.language),v(!1)}catch(a){f(a instanceof Error?a.message:"Failed to load space"),v(!1)}})()},[l]);const y=t.useCallback(s=>{switch(console.log("WebSocket message:",s),s.type){case"init":x(s.user_id),n(s.code),h(s.language),b(s.active_users);break;case"code_change":s.user_id!==g&&(k(!0),n(s.code),setTimeout(()=>k(!1),100));break;case"language_change":s.user_id!==g&&h(s.language);break;case"user_join":b(s.active_users);break;case"user_leave":b(s.active_users);break}},[g]),{sendMessage:j,isConnected:w}=T(`${$}/ws/${l}`,y,!p&&!S),C=t.useRef(null),L=t.useCallback(s=>{if(r)return;const a=s||"";n(a),C.current&&clearTimeout(C.current),C.current=window.setTimeout(()=>{j({type:"code_change",code:a})},200)},[j,r]),W=s=>{const a=s.target.value;h(a),j({type:"language_change",language:a})},E=async()=>{const s=`${window.location.origin}/space/${l}`;try{await navigator.clipboard.writeText(s),o(!0),setTimeout(()=>o(!1),2e3)}catch(a){console.error("Failed to copy:",a)}};return p?e.jsx("div",{className:"space-container",children:e.jsx("div",{className:"loading",children:"Loading space..."})}):S?e.jsx("div",{className:"space-container",children:e.jsxs("div",{className:"error-container",children:[e.jsxs("h2",{children:["‚ùå ",S]}),e.jsx("button",{onClick:()=>m("/"),className:"back-button",children:"Go Home"})]})}):e.jsxs("div",{className:"space-container",children:[e.jsxs("div",{className:"toolbar",children:[e.jsxs("div",{className:"toolbar-left",children:[e.jsxs("h2",{className:"space-title",children:[e.jsx("span",{className:"code-icon",children:"</>"}),"CodeCollab"]}),e.jsxs("div",{className:"status-indicator",children:[e.jsx("span",{className:`status-dot ${w?"connected":"disconnected"}`}),e.jsx("span",{className:"status-text",children:w?"Connected":"Reconnecting..."})]})]}),e.jsxs("div",{className:"toolbar-center",children:[e.jsxs("div",{className:"language-selector",children:[e.jsx("label",{htmlFor:"language",children:"Language:"}),e.jsx("select",{id:"language",value:d,onChange:W,className:"language-select",children:z.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"active-users",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:e.jsx("path",{d:"M8 8a3 3 0 100-6 3 3 0 000 6zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"})}),e.jsxs("span",{children:[i," online"]})]})]}),e.jsxs("div",{className:"toolbar-right",children:[e.jsx("button",{onClick:E,className:"copy-button",children:c?e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:e.jsx("path",{d:"M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"})}),"Copied!"]}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:[e.jsx("path",{d:"M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"}),e.jsx("path",{d:"M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"})]}),"Copy Link"]})}),e.jsx("button",{onClick:()=>m("/"),className:"leave-button",children:"Leave Space"})]})]}),e.jsx("div",{className:"editor-container",children:e.jsx(A,{height:"100%",language:d,value:u,onChange:L,theme:"vs-dark",options:{fontSize:14,minimap:{enabled:!0},scrollBeyondLastLine:!1,automaticLayout:!0,wordWrap:"on",lineNumbers:"on",glyphMargin:!0,folding:!0,lineDecorationsWidth:10,lineNumbersMinChars:3,renderLineHighlight:"all",cursorBlinking:"smooth",cursorSmoothCaretAnimation:"on",smoothScrolling:!0}})})]})}export{O as default};
